<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: users.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: users.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import express from 'express';
import { User } from '../models/user.js'; // import Usermodel
import passport from 'passport'; // import passport module
import '../js/passport.js'; //import passport.js file
import {
  userValidationRules,
  userUpdateValidationRules,
  validate
} from '../middlewares/validators/validator.js'; // import validator

const user_Router = express.Router();

// request to add a new user
user_Router.post('/', userValidationRules(), validate, (req, res, next) => {
  let hashedPassword = User.hashPassword(req.body.password); // calls hashPwd method in usermodel
  User.findOne({ username: req.body.username })
    .then(user => {
      if (user) {
        res.status(400).send(req.body.username + ' already exists');
      } else {
        User.create({
          username: req.body.username,
          password: hashedPassword,
          email: req.body.email,
          birthdate: req.body.birthdate
        })
          .then(user => {
            res.status(201).json(user);
          })
          .catch(next);
      }
    })
    .catch(next);
});

// request to update details of the user
user_Router.put(
  '/:username',
  userUpdateValidationRules(),
  validate,
  passport.authenticate('jwt', { session: false }),
  (req, res, next) => {
    User.findOneAndUpdate(
      { username: req.params.username },
      {
        $set: {
          username: req.body.username,
          password: req.body.password,
          email: req.body.email,
          birthdate: req.body.birthdate
        }
      },
      { new: true } // to ensure updated document is returned
    )
      .then(updatedUser => {
        if (updatedUser) {
          console.log(updatedUser);
          res.status(200).json(updatedUser);
        } else {
          console.log('no user found to update.');
          res
            .status(400)
            .send(req.params.username + ' not found in database to update.');
        }
      })
      .catch(next);
  }
);

// request to add a movie to the favorite list
user_Router.post(
  '/:username/movies/:movieId',
  passport.authenticate('jwt', { session: false }),
  (req, res, next) => {
    User.findOneAndUpdate(
      { username: req.params.username },
      {
        $push: {
          favoriteMovies: req.params.movieId
        }
      },
      { new: true }
    )
      .then(updatedUser => {
        console.log(updatedUser);
        res.status(200).json(updatedUser);
      })
      .catch(next);
  }
);

// request to remove a movie from favorite list
user_Router.delete(
  '/:username/movies/:movieId',
  passport.authenticate('jwt', { session: false }),
  (req, res, next) => {
    User.findOneAndUpdate(
      { username: req.params.username },
      {
        $pull: {
          favoriteMovies: req.params.movieId
        }
      },
      { new: true }
    )
      .then(updatedUser => {
        console.log(updatedUser);
        res.status(200).json(updatedUser);
      })
      .catch(next);
  }
);

// request to delete a user by id
user_Router.delete(
  '/:username',
  passport.authenticate('jwt', { session: false }),
  (req, res, next) => {
    User.findOneAndRemove({ username: req.params.username })
      .then(user => {
        if (!user) {
          res.status(404).send(req.params.username + ' was not found.');
        } else {
          res.status(200).send(req.params.username + ' was deleted.');
        }
      })
      .catch(next);
  }
);
/**
 *  end point that belongs to user route
 *  @exports user route
 */
export { user_Router };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-director.html">director</a></li><li><a href="module-movie.html">movie</a></li><li><a href="module-user.html">user</a></li></ul><h3>Global</h3><ul><li><a href="global.html#authCheck">authCheck</a></li><li><a href="global.html#generateswebtoken">generates web token</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Sat Feb 19 2022 18:09:17 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
